---
title: "Staying Safe: Analyzing Crime in San Francisco"
subtitle: "2020 Vision"
author: "Mihir Patel, Tina Xia, Leah Okamura, Kyra Cooperman"
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(broom)
sanfrancrimeBIG <- 
  read_csv("data/Police_Department_Incidents_-_Previous_Year__2016_.csv")

knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
```

### INTRODUCTION AND DATA

San Francisco is a city known for its strong economy and booming tech industry. 
In addition to Silicon Valley and San Jose, the Bay Area is home to many
powerful companies such as Google, Tesla, Apple, and Cisco. Because of these 
many benefits, San Francisco is a popular destination for college graduates. In 
May 2020, San Francisco was ranked second as the best metro area for recent 
graduates. This especially took into consideration the "high wages, work from 
home ability, and a (mainly) pandemic-resilient economy" that many recent 
graduates worry about during this time [1]. 

However, with an overall crime rate in San Francisco that is 151% higher than 
the national average, is it also important to note that in recent years, San 
Francisco has not been the safest place to live. The SFChronicle reported that 
compared to 2019, "homicides increased by 21.4% in San Francisco from March to 
June of this year,"[2]. There is a 1 in 15 chance of becoming a victim of any 
type of crime. A quick search about travel in San Francisco includes many 
articles listing the "Places to Avoid After Dark" or "Most Dangerous 
Neighborhoods in SF."With the a high possibility of any of us moving to San 
Francisco after our time at Duke,and the recent popularity with college 
graduates, we wanted to analyze this dataset to obtain conclusions about 
specific factors that correlate to higher levels of crime, which will could 
then inform us of some key insights we can keep during future travels or moves. 

Through our research, we plan to investigate what factors the general population
can associate with local crime in order to be the safest while in San Francisco.
Our main hypotheses are 1) a later time (e.g. nighttime hours) correlates to a 
higher level or rate of crime and 2) Location is correlated to levels of crime. 
We believe it is important to investigate this question because 
there likely are policy changes that can be implemented to increase safety
throughout the city. Our investigation will shine light on potential patterns
of crime.

For example,if there is a strong correlation between night and rate of crime, then 
is there a correlation between which night of the week (ex. Sunday night) and 
rate of crime? With location, are there certain districts that have a specific 
crime that is common there? By delving further and examining these 
relationships, we will be able to understand if crime has any specific pattern 
in San Francisco. 

In order to assess these hypotheses, we will look at the following relationships:
  1. Relationship between crime type and time
  2. Relationship between crime and time
  3. Relationship between violent crimes and police district
  4. Relationship between days of the week and crime

```{r dataglimpse}
set.seed(1)
sanfrancrime <- sanfrancrimeBIG %>%
  sample_n(15000)
```

The observations in the dataset are of crime data in San Francisco from 2016. We
found our dataset at https://www.kaggle.com/roshansharma/sanfranciso-crime-dataset. 
Each observation in this dataset is a crime whose various aspects have been 
recorded. There were originally 150,500 individual crimes/observations in this 
dataset. However, because of the nature of R Studio through OIT, we will be
taking a random and reproducible sample from the larger dataset. We created this
sample by using the function sample_n() on sanfrancrimeBIG to randomly select 
15,000 observations. We chose 15,000 because it is still large enough to get an 
accurate portrayal of the total data set, yet is much more manageable to process.

The curator of the dataset got it from the final assignment for Coursera and 
IBM's Data Visualization Course. The information in this dataset is most likely
directly from the San Francisco Police Department for their reported crimes 
during 2016. This dataset was originally used to practice analyzing and 
visualizing data through geo spatial mapping by using folium maps for 
geographical understanding. 


### METHODOLOGY

### Variables

We will analyze the validity of our hypotheses using various statistical methods, including a Chi-square test, bootstrapping, and a logistic regression model, among others. Note: we plan on grouping violence based on violent vs nonviolent. The main variables we will be using in our analysis are Category, DayOfWeek, Date, Time, PdDistrict, and Resolution. We also created new variables to assist us in our data. This includes the variable timerange, that organizes the hour of the day into four times of day "night", "morning", "day", and "evening."

```{r creating time and filtering for important variables}
important <- sanfrancrime %>%
  mutate(str = as.character(Time)) %>%
  mutate(hourstr = substr(str, 1, 2)) %>%
  mutate (hour = as.numeric(hourstr)) %>% 
  select(Category, DayOfWeek, Date, PdDistrict, Resolution, hour)

important <- important %>% 
  mutate(timerange = case_when( hour >= 0 & hour < 6 ~ "dawn",
                                hour >= 6 & hour < 12 ~ "morning",
                                hour >= 12 & hour < 18 ~ "afternoon",
                                hour >= 18 & hour < 24 ~ "night"))
```

We also decided to categorize the all of the different types of crime that were reported. We organized the 39 types of crimes into varable crimetype, which consists of "Property", "Violent", "White Collar", "Drug/Alcohol", "Sex", "Suspicious", "Legal Violation", and "Miscellaneous".

```{r categorizing crime by type}
important <- important %>% 
  mutate(crimetype = case_when(
    
    Category == "BURGLARY" | Category == "LARCENY/THEFT" | 
    Category == "STOLEN PROPERTY" | Category == "RECOVERED VEHICLE" |
    Category == "VEHICLE THEFT" | Category == "ARSON" |
    Category == "VANDALISM"  ~ "Property",
    
    Category == "ROBBERY" | Category == "ASSAULT" | 
    Category == "KIDNAPPING" | 
      Category == "SEX OFFENSES, FORCIBLE" ~ "Violent",
    
    Category == "BRIBERY" | Category == "BAD CHECKS" | 
    Category == "EMBEZZLEMENT"| Category == "FORGERY/COUNTERFEITING" |
    Category == "FRAUD" | Category == "GAMBLING"| 
    Category == "EXTORTION" ~ "White Collar",
    
    Category == "DRIVING UNDER THE INFLUENCE" | Category == "DRUG/NARCOTIC" | 
    Category == "DRUNKENNESS"| Category == "LIQUOR LAWS" ~ "Drug/Alcohol",
    
    Category == "PORNOGRAPHY/OBSCENE MAT" | Category == "PROSTITUTION" |
    Category == "SEX OFFENSES, NON FORCIBLE" ~ "Sex",

    Category == "LOITERING" | Category == "TREA" | 
    Category == "TRESPASS"| Category == "SUSPICIOUS OCC" |
    Category == "DISORDERLY CONDUCT" ~ "Suspicious",
    
    Category == "WARRANTS"|Category == "WEAPON LAWS" |
    Category == "SECONDARY CODES" ~ "Legal Violation",

    Category == "MISSING PERSON" |Category == "NON-CRIMINAL"|
    Category == "OTHER OFFENSES" |Category == "SUICIDE"| 
    Category == "FAMILY OFFENSES" | Category == "RUNAWAY" ~ "Miscellaneous"))
```


### Visualizations

```{r map-of-SF}
library(sf)
sfran <- st_read("data/Current Police Districts-2", quiet = TRUE)

# ggplot(sfran) +
#     geom_sf(color = "blue", size = 1.5, fill = "orange", alpha = 0.50) +
#     labs(title = "Current Police Districts in San Francisco Singled Out on a Map") +
#     theme_bw()

plot(sfran["district"], key.pos = 4, key.width = lcm(5), key.length = 1.0, main = "SF Police Districts") 
#plot(sfran["shape_area"], key.pos = 4, main = "Areas of SF Districts Colored by Size")

```

```{r day of week and number of crimes}
library(forcats)
sanfrancrime$DayOfWeek <- factor(sanfrancrime$DayOfWeek, levels= c("Sunday", "Monday", 
    "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))
day <- sanfrancrime%>%
  group_by(DayOfWeek)%>%
  mutate(cpday = n())%>%
  select(DayOfWeek, cpday)

ggplot(data = day, mapping = aes(x = DayOfWeek)) +
    geom_bar()  + labs(x = "Day", y = "Count",
      title = "Number of Crimes Per Day Suggest Equal Spread of Crime") 
```

One relationship we were interested in was if certain days had a higher rates of crime. We visualized this relationship by creating a bar graph that compares the day of the week and number of crimes each day during this time period. By looking at the visual, we are able to see that each has a relatively similar crime count compared to the other. In addition to this, there is no significant pattern that sticks out as well.


```{r day and crimetype}
important$DayOfWeek <- factor(important$DayOfWeek, levels= c("Sunday", "Monday", 
    "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))
crimetypeday <-important%>%
  group_by(crimetype)%>%
  mutate(ctcount = n())

ggplot(data = important, mapping = aes(x = DayOfWeek)) +
  geom_bar(aes(fill = crimetype), position = "dodge") +
  labs(x = "Day of the Week", y = "Count of Crime Type", 
       title = "Overall Similar Spread of Crime Type from Day to Day",
       fill= "Crime Type")
```

The faceted bar graph shows the frequency of each crime rate on a given day of the week. When looking at the visualization, it is easy to see the large difference between types of crime that exist. On each day, the number of property related crimes and miscellaneous crimes are significantly greater than the 5 other crime types. When looking at the frequency of crime types from day to day, every day has a similar pattern of frequency. This further supports the observation from the previous visualization where crime and day of the week do not necessarily have a relationship.


### 1 - Is there a relationship between crime type and time?

```{r colored-visualizations}
ggplot(data = important, mapping = aes(x = timerange)) +
  geom_bar(aes(fill = crimetype), position = "dodge") +
  labs(x = "Time of the Day", y = "Count of Crime Type", 
       title = "The most property crime happens in the evening",
       subtitle = "The most violent crime happens in the evening",
       fill= "Crime Type")
```

### 2 - Which PD has the highest proportion of violent crime?

```{r PD vs Violent Crime}
 # pd_violent <- sanfrancrime%>%
 #   group_by(Category)%>%
 #   count()

 important3 <- important

 important3 <- important%>%
   filter(PdDistrict!="NA")%>%
   group_by(PdDistrict)%>%
   mutate(yes_violent = crimetype == "Violent")%>%
   arrange(desc(yes_violent))

#### do we need to print this pipeline or was it for checking?
 important3%>%
   group_by(PdDistrict)%>%
   count(yes_violent)%>%
   mutate(perc = (n/sum(n)*100))%>%
   arrange(desc(perc))%>%
   filter(yes_violent=="TRUE")%>%
   select(PdDistrict, n, perc)
 

ggplot(important3, aes(x = PdDistrict, fill = yes_violent))+
  geom_bar(position = "fill") + coord_flip()+
  labs(title =
         "Ingleside, Mission, and Tenderloin Have Highest Violent Crime Rates ",
       y = "Proportion of Violent Crimes", x = "Police District")
```


By looking at the table and bar plot, it is clear that Ingleside, Mission, and 
Tenderloin have the highest rates of violent crime.

However, Mission, Southern, and Bayview have the highest number of violent crimes.
Park and Richmond both have the lowest rates and total numbers of violent crimes.
For all police districts, the percentage of violent crimes is lower than 18%. 



#Chi-Square Test

#Mihir
We will be performing a Chi-Squared test between these
crime types and categorical time of day to determine if there is the relationship between them is 
statistically significant.

$H_0:$ NO relationship between the crime types created above and categories for
time of day created above.

$H_a:$ There IS a relationship between the crime types created above and 
categories for time of day created above.
 
$\alpha$ of 0.05

```{r chi-squared time}

crimecount <- important %>%
  count(crimetype)

test <- important %>%
  group_by(crimetype) %>%
  count(timerange)

CrimeCategory <- c(rep(crimecount$crimetype[1], crimecount$n[1]),
               rep(crimecount$crimetype[2], crimecount$n[2]),
               rep(crimecount$crimetype[3], crimecount$n[3]),
               rep(crimecount$crimetype[4], crimecount$n[4]),
               rep(crimecount$crimetype[5], crimecount$n[5]),
               rep(crimecount$crimetype[6], crimecount$n[6]),
               rep(crimecount$crimetype[7], crimecount$n[7]),
               rep(crimecount$crimetype[8], crimecount$n[8]))

TimeOfDay <- c(
rep(test$timerange[1], test$n[1]), rep(test$timerange[2], test$n[2]), 
rep(test$timerange[3], test$n[3]), rep(test$timerange[4], test$n[4]),

rep(test$timerange[5], test$n[5]), rep(test$timerange[6], test$n[6]), 
rep(test$timerange[7], test$n[7]), rep(test$timerange[8], test$n[8]),

rep(test$timerange[9], test$n[9]), rep(test$timerange[10], test$n[10]), 
rep(test$timerange[11], test$n[11]), rep(test$timerange[12], test$n[12]),

rep(test$timerange[13], test$n[13]), rep(test$timerange[14], test$n[14]), 
rep(test$timerange[15], test$n[15]), rep(test$timerange[16], test$n[16]),

rep(test$timerange[17], test$n[17]), rep(test$timerange[18], test$n[18]), 
rep(test$timerange[19], test$n[19]), rep(test$timerange[20], test$n[20]),

rep(test$timerange[21], test$n[21]), rep(test$timerange[22], test$n[22]), 
rep(test$timerange[23], test$n[23]), rep(test$timerange[24], test$n[24]),

rep(test$timerange[25], test$n[25]), rep(test$timerange[26], test$n[26]), 
rep(test$timerange[27], test$n[27]), rep(test$timerange[28], test$n[28]),

rep(test$timerange[29], test$n[29]), rep(test$timerange[30], test$n[30]), 
rep(test$timerange[31], test$n[31]), rep(test$timerange[32], test$n[32]))


table <- table(CrimeCategory, TimeOfDay)
table

chisq.test(table)
```

# T Test

Given the significant p-value of our chi-square test statistic. We decided to conduct a hypothesis test to see how number of total crimes in San Francisco compares during the daylight and nightime.

We will now use the CLT to perform inference because the observations are 
independently selected and in this case, the sample size is large enough (n>30) 
for the CLT to apply. We are using t-distribution because we are testing a 
single sample's population mean and we don't know the true population SD.

$H_0:$ The true mean time of crimes committed during the week is equal to the true mean time of crimes committed during the weekend

$H_a:$ The true mean time of crimes committed during the week is less than true mean time of crimes committed during the weekend

$\alpha$ of 0.05

```{r crime_daylight_or_nighttime}
test_sanfrancrime <- important %>%
  mutate(weektype = ifelse(DayOfWeek == "Saturday" | DayOfWeek == "Sunday", "Weekend", "Weekday"),
         timerange = ifelse(hour >= 7 | hour < 19, "Nighttime", "Daylight"))

library(forcats)
test_sanfrancrime <- test_sanfrancrime%>%
  mutate(weekytype = factor(weektype, levels = c("Weekend","Weektype")))

test_sanfrancrime <- test_sanfrancrime%>%
  mutate(timerange = factor(timerange, levels = c("Nighttime","Daylight")))

# t.test(weektype ~ timerange,
#   data = test_sanfrancrime,
#   mu = 0,
#   var.equal = FALSE,
#   alternative = "greater",
#   conf.level = 0.95)


# test_sanfrancrime <- test_sanfrancrime%>%
#   filter(weektype == "Weekend")%>%
#   mutate(weekend_hour = hour)
# #test_sanfrancrime$weekend_hour
# 
# test_sanfrancrime <- test_sanfrancrime%>%
#   filter(weektype == "Weekday")%>%
#   mutate(weekday_hour = hour)
# #test_sanfrancrime$weekday_hour
```




# Logistic Regression

# Mihir

By using logistic regression, we hope to answer the question of how much more
likely a violent crime is to occur depending on the time range of the crime
committed. This model below shows the predicted proportion of crimes that are
violent given the predictor of time range. The three time ranges used are
evening, morning, and night. We hypothesize that the highest proportion of 
violent crimes will occur at night because there are typically fewer witnesses
at these hours. 

Before using logistic regression, we checked that all necessary conditions...

```{r logistic model}
condensed <- important %>% 
  mutate(isViolent = ifelse(crimetype == "Violent", 1, 0)) %>% 
  select(DayOfWeek, PdDistrict, timerange, isViolent)
#condensed

mod1 <- glm(isViolent ~ DayOfWeek + timerange, data = condensed,
  family = "binomial")
tidy(mod1)


condensed2 <- important %>% 
  mutate(isProp = ifelse(crimetype == "Property", 1, 0)) %>% 
  select(DayOfWeek, PdDistrict, timerange, isProp)
#condensed2

mod2 <- glm(isProp ~ DayOfWeek + timerange, data = condensed2,
  family = "binomial")
tidy(mod2)
```



<!-- #4- How does time range affect whether crimes are violent? Kyra -->

<!-- ```{r, echo = FALSE} -->
<!-- mod<- glm(yes_violent~timerange,  -->
<!--          data = important3) -->
<!-- tidy(mod) -->
<!-- ``` -->


### RESULTS

#Chi-Square Test

The test statistic is 359.84, which has a chi squared distribution with 18
df under $H_0$. The p-value is < 2.2e-16 which is less than the $\alpha$ 
of 0.05. This means there is sufficient evidence to reject the null 
hypothesis. As a result, I conclude that there is sufficient evidence to 
suggest that at the 0.05 significance level that there is a relationship between
the crime types created above and categories for time of day created above.


#Logistic Regression

#Mihir
For Violent Crime: 

Predicted logit(p) = -2.131 - 0.071* (Mon.) - 0.021* (Tues.) - 0.114* (Wed.) - 
0.145* (Thur.) - 0.148* (Fri.) + 0.079 * (Sat.) + 
0.608* (dawn) + 0.137* (morning) + 0.227* (night)


While holding the day of the week constant, the log odds of a violent crime occuring increases by 0.114 if morning, 0.227 if night, and 0.608 if it is dawn.

While holding the time range of the day constant, the log odds of a violent crime occuring decreases by 0.071 if Monday, 0.021 if Tuesday, 0.114 if Wednesday, 0.145 if Thursday, and 0.148 if it is Friday. However, the log-odds increase by 0.079 if it is Saturday. 

The reference level (not sure if that’s the correct term) is Sunday at Afternoon.

According to the model, the log-odds of a violent crime occuring is greatest when it is Saturday at Dawn and the least when it is Friday at Afternoon.


For Property Crime: 

Predicted logit(p) = -0.324 - 0.058* (Mon.) - 0.107* (Tues.) - 0.140* (Wed.) -  
0.287* (Thur.) - 0.093* (Fri.) - 0.048* (Sat.) - 
0.109* (dawn) - 0.115* (morning) + 0.396* (night)


While holding the day of the week constant, the log odds of a violent crime occuring decreases by 0.109 if night and 0.114 if it is dawn. However, the log-odds increase by 0.396 if it is morning.

While holding the time range of the day constant, the log odds of a violent crime occuring decreases by -0.058 if Monday, -0.107 if Tuesday, -0.140 if Wednesday, -0.287 if Thursday, -0.093 if Friday, and -0.048 if it is Saturday.

The reference level (not sure if that’s the correct term) is Sunday at Afternoon.

According to the model, the log-odds of a violent crime occuring is greatest when it is Sunday at Night and the least when it is Thursday at Morning.


#YUE: add quickly that we checked all conditions for regression, satisfied all conditions.



#Kyra
Predicted logit(yes_violent) = 
  0.10383 + 0.01188(evening) + 0.00227(morning) +0.06939(night)



### DISCUSSION

When trying to be safest in the busy city of San Francisco, we discovered through our analysis that certain measures can be taken to improve one's safety. This is proven by the multiple factors that influence where, what, and when crime is committed. However, it might first be important to discuss which factors do not play a substantial role in the act of a crime. For example, when looking at the bar graph comparing day of the week and number of crimes, it is clear that the difference from day to day is very minimal. Therefore, looking at just the day itself should not be a factor to whether it may be more dangerous or not. Looking at the visualization comparing type of crime and day of week furthers the point that the day of the week does not play a significant role on crime. Each day has a spread where Property Crime is the highest, followed by Miscellaneous Crime, followed by Violent Crime. Something that could cause a possible influence in our data is the fact that the variable crime type was by us, so the organization of what crime fits into what category and the creation of categories is based on our research and knowledge. 

In addition, after creating categorical variables for time of day and also categorizing the types of crime within larger categories, we determined that there was a statistically significant relationship between the time of day and type of crime. As a result, we created a logistic model to calculate the log-odds of whether a violent crime occurred with the predictors of day of the week and time of day. We also created a model with the same predictors for property crime. However, this model cannot be applied to all cities; the base concept should remain the same. Most cities will have likely have crime peak during the night and during the weekends because more people will not be home.

The bar graph that shows crime rates and violent crime proportions that is faceted by police districts shows valuable insight as to which police districts are faced with the highest crime rates. The police districts of Tenderloin, Mission, and Ingleside have the highest percentages of violent crime (17.7%, 16.6%, 16% respectively). However, it is Bayview, Northern, and Southern that have the highest total number of violent crimes (239, 202, 291 respectively). Park and Richmond were both consistent in having the lowest numbers of total violent crimes as well as proportion of violent crimes. Noting the success of these districts in maintaining low levels of crimes, it could be beneficial to restructure other districts to mirror their practices. 

An important factor that this analysis is lacking is the populations of each police district. Having a larger population size would likely contribute to greater numbers of crime, even if per capita crime is lower. This information is not present in the dataset we used, but would be necessary to extrapolate a greater conclusion regarding which police district is most dangerous. Given that factors such as poverty level and unemployment rates are main drivers for crime [1], it would be valuable to assess these numbers for each police district. It would also be important to know the differences in these factors for districts with more and less crime so that next steps can be taken to lower crime rates. For example, should a future study conclude that Park’s public education system has higher test scores than that of Bayview, improving schools could be the best step for mitigating crime.

From a policy standpoint, government leaders in San Francisco should consider having additional police on duty during the times when crime is more eminent (afternoon and night). Another course of action could be to simply hire more police trained in Larceny, Theft, and Assault, as they were the most prominent from the graphs. Again, we understand that we cannot extrapolate our analysis to every city; however, our conclusions will be generalizable to similar cities to a moderate degree. Other cities with similar infrastructure and economic conditions are more likely to utilize the analysis we've found — this analysis will not be applicable to Durham, NC, for example, because of the population density and overall difference in cities (SF is a bustling city, while Durham is a smaller, quaint town).  

If we were to continue work on the project, we would add to our analysis by introducing data from different cities that are comparable to San Francisco. It would be interesting to see the parallels in crime rates, as for many college students, traveling to their first job post-grad will be their first taste of independence and financial freedom -- thus, safety is an important factor to take into consideration. Ultimately, expanding the population of interest to citizens in multiple cities would give a better picture of how cases of crime occur differently by region, state, country, or population density (urban vs. rural). Second, we would also adjust for additional potential confounding variables to improve the accuracy of our analysis and models. Finally, to learn more, we'd want to speak with current or past residents and police officers about their first-hand local experiences with crime. Data is a great way to create thoughtful questions but it may not provide the full or complete answer.



### REFERENCES

[1] https://poetsandquantsforundergrads.com/2020/05/15/are-these-the-50-best-metro-areas-for-recent-college-grads/

[2] https://www.sfchronicle.com/bayarea/article/Which-crimes-are-up-down-in-SF-during-15408485.php

[3] https://www.sfchronicle.com/bayarea/philmatier/article/SF-ranks-high-in-property-crime-while-it-ranks-14439369.php

[4] https://ucr.fbi.gov/hate-crime/2011/resources/variables-affecting-crime 


### LINKS USED FOR SF MAP:
https://www.benjaminsorensen.me/project/sf_police/ 
https://data.sfgov.org/Public-Safety/Current-Police-Districts/wkhw-cjsf 
https://r-spatial.github.io/sf/articles/sf5.html#geometry-with-attributes-sf-1 


### TO DO LIST 

- t test MIHIR
- justifications methodology LEAH
- results add coefficient interpretations KYRA
- add regression model significance in discussion KYRA
- Discussion - organize it, add conclusion TINA done
- clean up data sets 
- interpret and add coefficients
- final repo should look like a paper from poli sci
- References - LEAH
- SLIDES - LEAH, TINA
